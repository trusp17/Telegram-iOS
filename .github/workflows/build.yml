name: CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: '0'

      - name: Install jq
        run: brew install jq

      - name: Set Xcode version
        run: |
          XCODE_VERSION=$(jq -r .xcode versions.json)
          sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          echo "Using Xcode $XCODE_VERSION"

      - name: Create working directory
        run: |
          sudo mkdir -p /Users/Shared
          cp -R $GITHUB_WORKSPACE /Users/Shared/
          mv /Users/Shared/$(basename $GITHUB_WORKSPACE) /Users/Shared/telegram-ios

      - name: Create correct appstore-configuration.json with sg_config
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
        run: |
          cd /Users/Shared/telegram-ios

          cat > build-system/appstore-configuration.json << 'EOF'
{
  "sg_config": {
    "enablePremium": true,
    "enableGhost": true,
    "enableAntiDelete": true,
    "enableForwardWithoutAuthor": true,
    "enableStoriesWithoutView": true,
    "enableLocalPremium": true
  },
  "appConfiguration": {
    "apiId": ${API_ID},
    "apiHash": "${API_HASH}",
    "appVersion": "12.2.1",
    "bundleId": "org.trusp17.swiftgram",
    "teamId": ""
  },
  "buildConfiguration": {
    "configuration": "release_arm64"
  }
}
EOF
          echo "appstore-configuration.json created with sg_config and API keys"

      - name: Generate Xcode project
        run: |
          cd /Users/Shared/telegram-ios
          mkdir -p "$HOME/telegram-bazel-cache"
          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/telegram-bazel-cache" \
            generateProject \
            --configurationPath=build-system/appstore-configuration.json \
            --xcodeManagedCodesigning \
            --overrideXcodeVersion

      - name: Build IPA
        run: |
          cd /Users/Shared/telegram-ios
          python3 -u build-system/Make/Make.py \
            --cacheDir="$HOME/telegram-bazel-cache" \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --configuration=release_arm64 \
            --buildNumber=99999

          mkdir -p build/artifacts
          find . -path "*/applebin_ios-ios_arm64-opt-ST-*/bin/Telegram/Telegram.ipa" -exec cp {} build/artifacts/ \;

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: SwiftGram-IPA-Latest
          path: /Users/Shared/telegram-ios/build/artifacts/Telegram.ipa
